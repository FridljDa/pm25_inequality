---
title: "numbers_for_text"
author: "Daniel Fridljand"
output: html_document
---

```{r setup, include=FALSE}
library(data.table)
library(dplyr)
library(magrittr)
library(scales)
library(ggplot2)
# library(tidyr)

options(scipen = 10000)
```

# Loading data
```{r load_calculated_data}
tracDir <- "../data/02_tracts"
exp_tracDir <- "../data/03_exp_tracts"
censDir <- "../data/05_demog"
cens_agrDir <- "../data/06_dem.agr/nation"
summaryDir <- "../data/17_summary"
#summaryDir <- "/Volumes/DanielDrive/PM2.5-attributable-mortality-analysis-private_042023/data/17_summary"

file_list <- list.files(summaryDir)
file_list <- file.path(summaryDir, file_list[grepl("attr_bur", file_list)])
attr_burden <- lapply(file_list, fread) %>% rbindlist(use.names = T, fill = TRUE)
rm(file_list)

all_burden <- fread(file.path(summaryDir, "all_burd.csv"))
pm_summ <- fread(file.path(summaryDir, "pm_summary.csv"))
pm_summ <- pm_summ %>% filter(scenario == "real")
#pop_summary <- fread(file.path(summaryDir, "pop_summary.csv"))
```
# Mortality counts

```{r}
# total_burden_nvss_2016 <- read_csv("data/09_total_burden_parsed/nation/nvss/total_burden_nvss_2016.csv")

total_burden_nvss <- lapply(
  list.files("../data/09_total_burden_parsed/nation/nvss/"),
  function(path) {
    total_burden_nvss_i <- fread(file.path("../data/09_total_burden_parsed/nation/nvss", path))
    total_burden_nvss_i <- total_burden_nvss_i %>%
      filter(Race == "All" & Hispanic.Origin == "All Origins" & rural_urban_class == 666 & label_cause == "all-cause" &
        Education == "666") %>%
      group_by(Year) %>%
      summarise(Deaths = sum(Deaths))
  }
)

total_burden_nvss <- total_burden_nvss %>% rbindlist(use.names = T)
total_burden_nvss %>% filter(Year %in% c(1990, 2016))
```

```{r}
sum(total_burden_nvss$Deaths)
```

# Exposure to PM2.5 at the national level:
census tracts exposed to an annual mean PM2.5 concentration above 12µg/m3 in 2016
```{r}
exp_trac_files_2016 <- list.files(file.path(exp_tracDir, "2016"))
exp_tracts_2016 <- lapply(exp_trac_files_2016, function(file) {
  file.path(exp_tracDir, "2016", file) %>%
    fread() %>%
    mutate(GEO_ID = as.numeric(GEO_ID))
})

exp_tracts_2016 <- rbindlist(exp_tracts_2016, fill = TRUE)

scales::label_percent(0.1)(sum(exp_tracts_2016$pm > 12) / nrow(exp_tracts_2016))
```

census tracts exposed to an annual mean PM2.5 concentration above 12µg/m3 in 1990
```{r}
exp_trac_files_1990 <- list.files(file.path(exp_tracDir, "1990"))
exp_tracts_1990 <- lapply(exp_trac_files_1990, function(file) {
  file.path(exp_tracDir, "1990", file) %>%
    fread() %>%
    mutate(GEO_ID = toString(GEO_ID))
})

exp_tracts_1990 <- rbindlist(exp_tracts_1990, fill = TRUE)
scales::label_percent(0.1)(sum(exp_tracts_1990$pm > 12) / nrow(exp_tracts_1990))
```

overall population exposed to an annual mean PM2.5 concentration above 12µg/m3

```{r, eval = FALSE}
## what part of population affected
cens_meta_1990 <- fread(file.path(censDir, "meta", paste0("cens_meta_", "1990", ".csv")))

cens_agr_1990 <- fread(file.path(cens_agrDir, "1990", paste0("cens_agr_", "1990", "_us.csv"))) %>% filter(scenario == "real")

cens_agr_1990 <- left_join(cens_agr_1990, cens_meta_1990, by = "variable")

cens_meta_2016 <- fread(file.path(censDir, "meta", paste0("cens_meta_", "2016", ".csv")))

cens_agr_2016 <- fread(file.path(cens_agrDir, "2016", paste0("cens_agr_", "2016", "_us.csv"))) %>% filter(scenario == "real")

cens_agr_2016 <- left_join(cens_agr_2016, cens_meta_2016, by = "variable")

pop_exposed_over_12 <- rbind(cens_agr_1990, cens_agr_2016) %>%
  as.data.frame() %>%
  group_by(Year, Race, Hispanic.Origin, pm) %>%
  dplyr::summarize(pop_size = sum(pop_size)) %>%
  filter(Year %in% c(1990, 2016) & Race == "All" & Hispanic.Origin == "All Origins") %>%
  group_by(Year, Race, Hispanic.Origin) %>%
  mutate(prop = pop_size / sum(pop_size)) %>%
  ungroup() %>%
  mutate(above = pm > 12)

pop_exposed_over_12 <- pop_exposed_over_12 %>%
  group_by(Year, Race, Hispanic.Origin, above) %>%
  dplyr::summarize(
    prop = scales::label_percent(0.1)(sum(prop))
  )
pop_exposed_over_12
```
population-weighted mean PM2.5 exposure in the overall study population 
```{r}
pm_summ %>%
  filter(Ethnicity != "All, All Origins" & Region == "United States" & Year >= 2000 & Year <= 2016 &
    Education == 666 & rural_urban_class == "All" & pm_metric == "mean" & svi_bin == "All"& svi_bin1 == "All" & svi_bin2 == "All" & svi_bin3 == "All" & svi_bin4 == "All" & min_age == 25) %>% 
  group_by(Ethnicity) %>%
  summarise(value = round(mean(value), 2)#,
         #mean_lower = round(mean(mean_lower), 2),
         #mean_upper = round(mean(mean_upper), 2)
         ) %>%
  arrange(desc(value))
```
```{r}
pm_summ %>%
  filter(Ethnicity %in% c("Black American", "NH White") & Region == "United States" & Year %in% c(2000, 2001,2016) &
    Education == 666 & rural_urban_class == "All" & pm_metric == "mean" & svi_bin == "All"& svi_bin1 == "All" & svi_bin2 == "All" & svi_bin3 == "All" & svi_bin4 == "All" & min_age == 25) %>% 
  group_by(Ethnicity) %>%
  select(Year, Ethnicity, value)
```


```{r}
pm_summ %>%
  filter(Ethnicity == "All, All Origins" & Region == "United States" & Year %in% c(1990, 2016) &
    Education == 666 & rural_urban_class == "All" & pm_metric == "mean" & svi_bin == "666"& svi_bin1 == "666" & svi_bin2 == "666" & svi_bin3 == "666" & svi_bin4 == "666" & min_age == 25) %>%
  mutate(value = round(value, 2),
         mean_lower = round(mean_lower, 2),
         mean_upper = round(mean_upper, 2)
         ) %>%
  select(value, mean_lower, mean_upper, Year, everything())
```


# PM2.5-attributable mortality at the national level in 2016:
In the overall population, the estimated PM2.5-attributable mortality declined from 79.2 (95% CI, 77.1 to 81.4) age-adjusted deaths per 100,000 in 1990 to 11.7 (95% CI, 11.4 to 12.0) in 2016. 

```{r}
attr_burden %>%
  filter(svi_bin == "All" & svi_bin1 == "All" & svi_bin2 == "All" & svi_bin3 == "All" & svi_bin4 == "All") %>%
  filter(Gender.Code == "All genders" & measure1 == "Deaths" & measure2 == "age-adjusted rate per 100,000" & min_age == 25 &
    Region == "United States" &
    Year %in% c(1990, 2016) & method == "di_gee" & measure3 == "value" & scenario == "real" &
    Education == 666 & Ethnicity == "All, All Origins" & rural_urban_class == "All") %>%
  mutate(
    mean = round(mean, 1),
    lower = round(lower, 1),
    upper = round(upper, 1)
  ) %>%
  select(Year, mean, lower, upper, Education, Ethnicity, rural_urban_class)
```

```{r}
attr_burden_2016 <- attr_burden %>%
  filter(Gender.Code == "All genders" & measure1 == "Deaths" & measure2 == "age-adjusted rate per 100,000" &
    Region == "United States" &
    Year %in% c(2016) & method == "di_gee" & measure3 == "value" & scenario == "real") %>%
  select(Ethnicity, Education, rural_urban_class, mean, Year) %>%
  mutate(mean = round(mean, 1))

attr_burden_2016_overall <- attr_burden_2016[attr_burden_2016$Education == 666 & attr_burden_2016$Ethnicity == "All, All Origins" & attr_burden_2016$rural_urban_class == "All", "mean"]
attr_burden_2016_overall <- unlist(attr_burden_2016_overall)
attr_burden_2016_overall

attr_burden_2016 %>%
  split(attr_burden_2016$mean <= attr_burden_2016_overall)
```

# Time trends in PM2.5-attributable mortality at the national level:
## overall population
```{r}
attr_burden %>%
  filter(svi_bin == "All" & svi_bin1 == "All" & svi_bin2 == "All" & svi_bin3 == "All" & svi_bin4 == "All") %>%
  filter(Gender.Code == "All genders" & measure1 == "Deaths" & measure2 == "age-adjusted rate per 100,000" &
    Region == "United States" &
    Year %in% c(1990, 2016) & method == "di_gee" & measure3 == "value" & scenario == "real" &
    Education == 666 & Ethnicity == "All, All Origins" & rural_urban_class == "All") %>%
  mutate(
    mean = round(mean, 1),
    lower = round(lower, 1),
    upper = round(upper, 1)
  ) %>%
  select(Year, mean, lower, upper, Education, Ethnicity, rural_urban_class)
```
We observed this steep downward trend for all studied subpopulations, with absolute differences between these groups narrowing considerably over the study period

```{r}
attr_burden_absolute_difference_within_group <- attr_burden %>%
  filter(method == "di_gee" & Region == "United States" & scenario == "real" &
    Gender.Code == "All genders" & measure1 == "Deaths" & measure2 == "age-adjusted rate per 100,000" & measure3 == "value") %>%
  filter((Ethnicity == "All, All Origins" & rural_urban_class == "All") |
    (Ethnicity == "All, All Origins" & Education == 666 & Year >= 2000) |
    (rural_urban_class == "All" & Education == 666)) %>%
  mutate(group = case_when(
    Ethnicity == "All, All Origins" & Education == 666 & rural_urban_class == 666 ~ "All",
    Ethnicity == "All, All Origins" & Education == 666 ~ "Urbanicity",
    Ethnicity == "All, All Origins" & Education != 666 ~ "Education",
    Ethnicity != "All, All Origins" & Education == 666 ~ "Ethnicity",
    TRUE ~ "none"
  )) %>%
  group_by(Year, group) %>%
  summarise(min = min(mean), max = max(mean)) %>%
  mutate(dif = max - min) %>%
  as.data.frame()
ggplot(attr_burden_absolute_difference_within_group, aes(x = Year, y = dif, color = group)) +
  geom_line()
```

Black or African Americans have seen an estimated 85.7% reduction in the PM2.5-attributable age-adjusted mortality rate from 1990 to 2016

```{r}
attr_burden_temp <- attr_burden %>%
  filter(svi_bin == "All" & svi_bin1 == "All" & svi_bin2 == "All" & svi_bin3 == "All" & svi_bin4 == "All") %>%
  filter(Gender.Code == "All genders" & measure1 == "Deaths" & measure2 == "age-adjusted rate per 100,000" & min_age == 25 &
    Region == "United States" & #TODO 1990 not 1992
    Year %in% c(1992, 2016) & method == "di_gee" & measure3 == "value" & scenario == "real" &
    Education == 666 & Ethnicity == "Black American" & rural_urban_class == "All") %>%
  select(Year, Ethnicity, mean, lower, upper) #%>%
  #rowwise() %>%

#1-51.32873/299.50718
#attach(attr_burden_temp)
#temp <- delta_method_quotient(mean[Year == 2016], lower[Year == 2016], upper[Year == 2016], mean[Year == 1990], lower[Year == 1990], upper[Year == 1990], alpha = 0.05)
#temp <- unlist(temp)
#temp <- 1-temp
#100*temp
```
 

# Proportion of all-cause mortality that is attributable to PM2.5 exposure

Of note, the declines in PM2.5 exposure over the study period have led to a decrease in the percent of all-cause mortality that is attributable to PM2.5 among each of our population subgroups. Unlike the decline in the PM2.5-attributable mortality rate over time, this finding was not self-evident because it indicates that for each population subgroup mortality from PM2.5 decreased more rapidly than mortality from other causes.
```{r}
attr_burden %>%
  filter(svi_bin == "All" & svi_bin1 == "All" & svi_bin2 == "All" & svi_bin3 == "All" & svi_bin4 == "All") %>%
  filter(method == "di_gee" & Region == "United States" & scenario == "real" &
    Gender.Code == "All genders" & measure1 == "Deaths" & measure2 == "age-adjusted rate per 100,000" &
    Year == 2016 & measure3 == "prop. of overall burden") %>%
  filter((Ethnicity == "All, All Origins" & rural_urban_class == "All") |
    (Ethnicity == "All, All Origins" & Education == 666) |
    (rural_urban_class == "All" & Education == 666)) %>%
  arrange(mean) %>%
  mutate(
    mean = round(mean, 1),
    lower = round(lower, 1),
    upper = round(upper, 1)
  ) %>%
  select(mean, lower, upper, everything()) %>%
  arrange(desc(mean))
```
TODO More than half of the difference in all-cause mortality between Black Americans and the NH White population was attributable to PM2.5 in each year from 2000 to 2015 (Fig. 2). With a decrease from 70.2% in 2000 to 59.0% in 2015, this proportion, however, has declined considerably over time. 
```{r}
attr_burden %>%
  filter(Year %in% c(2000, 2015) & svi_bin == "All" & svi_bin1 == "All" & svi_bin2 == "All" & svi_bin3 == "All" & svi_bin4 == "All" & rural_urban_class == "All" & Education == 666 & method == "di_gee" & scenario == "real" & measure2 == "age-adjusted rate per 100,000" & Ethnicity == "NH White" & Region == "United States" & min_age == 25 ) 

attr_burden %>%
  filter(Year %in% c(2000, 2015) & svi_bin == "All" & svi_bin1 == "All" & svi_bin2 == "All" & svi_bin3 == "All" & svi_bin4 == "All" & rural_urban_class == "All" & Education == 666 & method == "di_gee" & scenario == "real" & measure2 == "age-adjusted rate per 100,000" & Ethnicity == "NH White" & Region == "United States" & min_age == 25 & measure3 == "proportion of disparity to Black or African American attributable") %>%
  select(Year, mean, lower, upper)#& 
```

TODO Those with low education, the Hispanic White population, and Black or African Americans had a higher PM2.5-attributable mortality than the respective average for every rurality level in 2016 (for example, in large metro areas, 15.1 age-adjusted deaths per 100,000 for the overall population, 21.1 for those with low education, 29.0 for Hispanic Whites, and 58.4 for Black or African Americans). 

TODO Absolute disparities in PM2.5-attributable mortality were more pronounced in more urbanized areas. 

TODO We found that this also tends to be the case within states in the US.

# Variation in PM2.5-attributable mortality across states and counties:
In all states studied, Black or African Americans had higher or equal PM2.5-attributable mortality in 2016 than the NH White population.
```{r}
## count states, where whites less affected
attr_burden %>%
  filter(Ethnicity %in% c("White, Not Hispanic or Latino", "Black American") &
    Gender.Code == "All genders" & measure1 == "Deaths" & measure2 == "age-adjusted rate per 100,000" & Region != "United States" &
    Year == 2016 & method == "di_gee" & measure3 == "value") %>%
  group_by(Year, Region, scenario) %>%
  slice(which.max(mean)) %>%
  group_by(scenario, Ethnicity) %>%
  summarise(n = n())
```

TODO Similarly, those with a high school diploma or lower education had a higher or equal PM2.5-attributable mortality in all states compared to groups with a higher level of education. 

TODO For rurality, in 44 states, large metro areas had a higher or equal PM2.5-attributable mortality compared to non-metro areas


At the county level, iIn 82.7% of the counties for which data were available, Black or African Americans had higher PM2.5-attributable mortality than the NH White population (Fig. S4, Panel B) for the mean value across the period 2000 toin 2016.
```{r}
attr_burdenDir <- here::here("data/14_attr_burd")
agr_bys <- "county"
attr_burd_county <- lapply(agr_bys, function(agr_by) {
  sources <- list.files(file.path(attr_burdenDir, agr_by))
  attr_burden <- lapply(sources, function(source) {
    files <- list.files(file.path(attr_burdenDir, agr_by, source))
    attr_burden <- lapply(files, function(file) fread(file.path(attr_burdenDir, agr_by, source, file))) %>% rbindlist(use.names = TRUE)
  }) %>% rbindlist(use.names = TRUE)

  return(attr_burden)
}) %>%
  rbindlist(use.names = TRUE) %>%
  as.data.frame()

attr_burd_county_sub <- attr_burd_county %>%
  filter(
    method == "di_gee" & Year %in% 2000:2016 & measure2 == "age-adjusted rate" &
      Education == 666 & scenario == "real"
  )

attr_burd_county_sub <- attr_burd_county_sub %>%
  unite("Ethnicity", Race, Hispanic.Origin, sep = ", ")

attr_burd_county_sub <- attr_burd_county_sub %>%
  mutate(
    Ethnicity = as.factor(Ethnicity),
    Ethnicity = forcats::fct_recode(Ethnicity,
      "Black American" = "Black or African American, All Origins",
      "NH White" = "White, Not Hispanic or Latino"
    )
  )

attr_burd_county_sub <- attr_burd_county_sub %>%
  filter(Ethnicity %in% c("Black American", "NH White"))

# attr_burd_county_sub <- attr_burd_county_sub %>%
#  group_by(Year, county, Ethnicity) %>%
#  filter(n()>1)
attr_burd_county_sub <- attr_burd_county_sub %>%
  group_by(Year, county) %>%
  filter("NH White" %in% c(Ethnicity) & "Black American" %in% c(Ethnicity))

attr_burd_county_sub <- attr_burd_county_sub %>%
  group_by(county, Ethnicity) %>%
  summarise(mean = mean(mean)) %>%
  ungroup()

attr_burd_county_sub <- attr_burd_county_sub %>%
  group_by(county) %>%
  filter("NH White" %in% c(Ethnicity) & "Black American" %in% c(Ethnicity)) %>%
  mutate(difference = mean[Ethnicity == "Black American"] - mean[Ethnicity == "NH White"]) %>%
  ungroup()

scales::label_percent(0.1)(mean(attr_burd_county_sub$difference > 0))
```


## Comparison to CRFs that do not provide race-ethnicity-specific estimates
mplementing this stylized scenario leads to substantially lower variation by race-ethnicity (Fig. S5a), with only x.x% of the difference in mortality to Black or African Americans being attributable to PM2.5 in each year from 2000 to 2015
```{r}
attr_burden %>%
  filter(svi_bin == "All" & svi_bin1 == "All" & svi_bin2 == "All" & svi_bin3 == "All" &svi_bin4 == "All" & min_age == 25)  %>%
  filter(Gender.Code == "All genders" & measure1 == "Deaths" & measure2 == "age-adjusted rate per 100,000" &
    attr == "attributable" &
    source == "National Vital Statistics System" & scenario == "real") %>%
  filter(agr_by == "nation" & Education == 666 & Ethnicity != "All, All Origins" & measure3 == "proportion of disparity to Black or African American attributable" & rural_urban_class == "All" &
    method %in% c("di_gee_white")) %>%
  filter(Year >= 2000 & Ethnicity == "NH White") %>%
  select(Year, mean, lower, upper)
```

# Materials and Methods, Data sources:


##  Ascertaining race-ethnicity:
```{r study_population}
#
pop_summary %>%
  filter(Region == "United States" & Gender.Code == "All genders" & Education == 666 & Ethnicity != "All, All Origins" & rural_urban_class == "All" &
    Year %in% c(1990, 2016) &
    source2 == "Official Bridged-Race Population Estimates" & svi_bin == "666"& svi_bin1 == "666" & svi_bin2 == "666" & svi_bin3 == "666" & svi_bin4 == "666") %>%
  group_by(Year) %>%
  mutate(
    prop = scales::label_percent(0.1)(Population / sum(Population))
  ) %>%
  select(Year, Ethnicity, prop)
```

## Ascertaining educational attainment:
```{r}
pop_summary %>%
  filter(Region == "United States" & Gender.Code == "All genders" & Education != 666 & rural_urban_class == "All" & Year %in% c(2009, 2016) & Ethnicity == "All, All Origins") %>%
  group_by(Year) %>%
  mutate(
    prop = scales::label_percent(0.1)(Population / sum(Population))
  ) %>%
  select(Year, prop, Education)
```

## Ascertaining rurality:
```{r}
pop_summary %>%
  filter(Region == "United States" & Gender.Code == "All genders" & Education == 666 & Ethnicity == "All, All Origins" & rural_urban_class != "All" & Year %in% c(2000, 2016)) %>%
  group_by(Year) %>%
  mutate(
    prop = scales::label_percent(0.1)(Population / sum(Population))
  ) %>%
  select(Year, rural_urban_class, prop)
```


## PM2.5 per race-ethnicity
```{r}
summaryDir <- here::here("data/17_summary")
min_ageI <- 25

file_list <- list.files(summaryDir)
file_list <- file.path(summaryDir, file_list[grepl("attr_bur", file_list)])
pm_summ <- fread(file.path(summaryDir, "pm_summary.csv"))
pm_summ <- pm_summ %>% filter(min_age == min_ageI)
```

```{r}
pm_summ <- pm_summ %>%
  filter(Region == "United States")

pm_summ <- pm_summ %>%
  filter(Gender.Code == "All genders" & Region == "United States" & pm_metric == "mean" & scenario == "real")

## -- figure 3, attributable burden---
pm_summ <- pm_summ %>% filter(Education == 666 & Ethnicity != "All, All Origins" & rural_urban_class == "All" & svi_bin == "All" & svi_bin1 == "All" & svi_bin2 == "All"& svi_bin3 == "All"& svi_bin4 == "All")

pm_summ <- pm_summ %>% filter(Year >= 2000 & Ethnicity != "White")
```

```{r}
pm_summ %>%
  group_by(Ethnicity) %>%
  summarise(value = mean(value) %>%
    round(digits = 2), .groups = "drop") %>%
  arrange(desc(value))
```

```{r}
pm_summ %>%
  filter(Year %in% c(2000, 2016)) %>%
  filter(Ethnicity %in% c("NH White", "Black American")) %>% 
  select(Ethnicity, Year, value, mean_lower, mean_upper) %>%
  mutate(value = value  %>% round(digits = 2),
         mean_lower = mean_lower %>% round(digits = 2),
         mean_upper = mean_upper  %>% round(digits = 2))
```

```{r}
library(dplyr)

# Your data
#pm_summ <- data.frame(
#  Ethnicity = c("Black American", "NH White", "Black American", "NH White"),
#  Year = c(2000, 2000, 2016, 2016),
#  value = c(14.31, 12.14, 7.95, 7.01),
#  mean_lower = c(14.18, 12.10, 7.83, 6.92),
#  mean_upper = c(14.42, 12.27, 8.02, 7.10)
#)

# Filter and mutate
filtered_data <- pm_summ %>%
  filter(Year %in% c(2000, 2016)) %>%
  filter(Ethnicity %in% c("NH White", "Black American")) %>% 
  select(Ethnicity, Year, value, mean_lower, mean_upper) %>%
  mutate(value = round(value, 2),
         mean_lower = round(mean_lower, 2),
         mean_upper = round(mean_upper, 2))

# Calculate disparities
disparities <- filtered_data %>%
  group_by(Year) %>%
  summarize(
    black_value = value[Ethnicity == "Black American"],
    white_value = value[Ethnicity == "NH White"],
    black_lb = mean_lower[Ethnicity == "Black American"],
    white_lb = mean_lower[Ethnicity == "NH White"],
    black_ub = mean_upper[Ethnicity == "Black American"],
    white_ub = mean_upper[Ethnicity == "NH White"]
  ) %>%
  rowwise() %>%
  mutate(
    disparity = list(
      delta_method_sum(
        mean_x = black_value,
        lb_x = black_lb,
        ub_x = black_ub,
        mean_y = -white_value,  # Negative for disparity
        lb_y = -white_ub,  # Reverse bounds
        ub_y = -white_lb   # Reverse bounds
      )
    )
  ) %>%
  unnest_wider(disparity)

disparities <- disparities %>%
  mutate(across(c(mean, lb, ub), round, 2)) %>%
        select(Year, mean, lb, ub)
print(disparities)
```

 
## Analysis by education and rural-ruban class
```{r}
attr_burden %>%
  filter(Region == "United States" & svi_bin == "All" & Ethnicity == "All, All Origins" & Education != 666 &
    rural_urban_class == "All" & min_age == 25 &
    Gender.Code == "All genders" & measure1 == "Deaths" & measure2 == "age-adjusted rate per 100,000" &
    Year %in% c(2016) # 2009,
  & method == "di_gee" & measure3 == "value" &
    scenario == "real") %>%
  transmute(
    Year, Education,
    mean = round(mean, 1),
    lower = round(lower, 1),
    upper = round(upper, 1)
  ) # %>%
# ggplot(aes(x = Year, y= mean, color = Education)) +
# geom_line()
```

```{r}
attr_burden %>%
  filter(Region == "United States" & svi_bin == "All" & Ethnicity == "All, All Origins" & Education == 666 &
    rural_urban_class != "All" & min_age == 25 &
    Gender.Code == "All genders" & measure1 == "Deaths" & measure2 == "age-adjusted rate per 100,000" &
    # Year %in% c(2016) & #2009,
    method == "di_gee" & measure3 == "value" &
    scenario == "real") %>%
  transmute(
    Year, rural_urban_class,
    mean = round(mean, 1),
    lower = round(lower, 1),
    upper = round(upper, 1)
  ) %>%
  ggplot(aes(x = Year, y = mean, color = rural_urban_class)) +
  geom_line()
```
```{r}
attr_burden %>%
  filter(Region == "United States" & svi_bin == "All" & Ethnicity == "All, All Origins" & Education == 666 &
    rural_urban_class != "All" & min_age == 25 &
    Gender.Code == "All genders" & measure1 == "Deaths" & measure2 == "age-adjusted rate per 100,000" &
    Year %in% c(1990, 2016) & # 2009,
    method == "di_gee" & measure3 == "value" &
    scenario == "real") %>%
  group_by(Year) %>%
  summarize(
    max_abs_diff = max(mean) - min(mean),
    rel_diff = max(mean) / min(mean),
    .groups = "drop"
  ) %>%
  transmute(
    Year, # rural_urban_class,
    max_abs_diff = round(max_abs_diff, 2),
    rel_diff = round(rel_diff, 2)
  )
# %>%
# ggplot(aes(x = Year, y= mean, color = rural_urban_class)) +
# geom_line()
```

## split filter
```{r}
# Filter and prepare data
attr_burd_filtered_dfs <- attr_burden %>%
  filter(Gender.Code == "All genders" & measure1 == "Deaths" &
    attr == "attributable" &
    source == "National Vital Statistics System" & scenario == "real" &
    agr_by == "nation" & method == "di_gee" & measure2 == "age-adjusted rate per 100,000" & min_age == 25 &
    measure3 == "value")


attr_burd_filtered_dfs <- generate_filtered_dfs(attr_burd_filtered_dfs)

attr_burd_filtered_dfs_names <- names(attr_burd_filtered_dfs)

# Filter names to include only those with '*'
attr_burd_filtered_dfs_names <- attr_burd_filtered_dfs_names[grep("\\*", attr_burd_filtered_dfs_names)]
attr_burd_filtered_dfs <- attr_burd_filtered_dfs[attr_burd_filtered_dfs_names]

attr_burd_filtered_dfs_test <- lapply(seq_along(attr_burd_filtered_dfs), function(i) {
  attr_burd_prop_filtered_dfs_names_i <- attr_burd_filtered_dfs_names[i]
  attr_burd_filtered_dfs_i <- attr_burd_filtered_dfs[[i]]

  split_color_var <- strsplit(attr_burd_prop_filtered_dfs_names_i, "\\*")
  split_color_var <- unlist(split_color_var)

  color.column <- split_color_var[[1]]
  split.column <- split_color_var[[2]]

  attr_burd_filtered_dfs_i %>%
    group_by(across(c(split.column, "Year"))) %>%
    mutate(n = n()) %>%
    ungroup() %>%
    group_by(across(c(split.column, "Year", "n"))) %>%
    summarise(
      CoV = sqrt(var(mean, na.rm = TRUE)) / mean(mean, na.rm = TRUE),
      max_abs_diff = max(mean, na.rm = TRUE) - min(mean, na.rm = TRUE),
      rel_diff = max(mean, na.rm = TRUE) / min(mean, na.rm = TRUE),
      average = mean(mean, na.rm = TRUE),
      over = list(unique(.data[[color.column]][mean >= average]))
    )
})
names(attr_burd_filtered_dfs_test) <- names(attr_burd_filtered_dfs)
```


```{r}
lapply(attr_burd_filtered_dfs_test, function(x) {
  x <- x %>%
    filter(Year == 2016) %>%
    pull(over)
  "High school graduate or lower" %in% x | "Black American" %in% x
})
```
With a decrease from 70.2% in 2000 to 59.0% in 2015, this proportion, however, has declined considerably over time. 
```{r}
attr_burden %>%
  filter(Year %in% c(2000, 2015) & svi_bin == "All" & svi_bin1 == "All" & svi_bin2 == "All" & svi_bin3 == "All" & svi_bin4 == "All" & rural_urban_class == "All" & Education == 666 & method == "di_gee" & scenario == "real" & measure2 == "age-adjusted rate per 100,000" & Ethnicity %in% c("NH White", "Black American") & Region == "United States" & min_age == 25 & measure3 == "proportion of disparity to Black or African American attributable") %>%
  select(Year, Ethnicity, mean, lower, upper) #
```
```{r}
attr_burden %>%
  filter(Year %in% 2000:2015 & svi_bin == "All" & svi_bin1 == "All" & svi_bin2 == "All" & svi_bin3 == "All" & svi_bin4 == "All" & rural_urban_class == "All" & Education == 666 & method == "di_gee" & scenario == "real" & measure2 == "age-adjusted rate per 100,000" & Region == "United States" & min_age == 25 & measure3 == "proportion of disparity to Black or African American attributable" & Ethnicity %in% c("Hispanic or Latino White", "Asian or Pacific Islander", "American Indian or Alaska Native")) %>%
  select(mean, lower, upper)
```

Nonetheless, at a mean for the period 2000 to 2015 of 25.4%, 19.8%, and 33.6% for the Hispanic or Latino White, Asian or Pacific Islander, and American Indian or Alaska Native population, respectively, the percentages were still substantial

```{r}
attr_burden %>%
  filter(
    Year %in% 2000:2015 & svi_bin == "All" & svi_bin1 == "All" & svi_bin2 == "All" & 
    svi_bin3 == "All" & svi_bin4 == "All" & rural_urban_class == "All" & 
    Education == 666 & method == "di_gee" & scenario == "real" & 
    measure2 == "age-adjusted rate per 100,000" & Region == "United States" & 
    min_age == 25 & measure3 == "proportion of disparity to Black or African American attributable" & 
    Ethnicity %in% c("Hispanic or Latino White", "Asian or Pacific Islander", "American Indian or Alaska Native")
  ) %>%
  select(Ethnicity, mean, lower, upper) %>%
  na.omit() %>%
  group_by(Ethnicity) %>%
  do(parametric_bootstrap_mean(., n_bootstrap = 1000)) %>%
  ungroup() %>%
  arrange(desc(mean)) %>%
  mutate(mean = round(100*mean,1),
         lower = round(100*lower,1),
         upper = round(100*upper,1))
```

```{r}
attr_burden %>%
  filter(Year %in% 2000:2015 & svi_bin == "All" & svi_bin1 == "All" & svi_bin2 == "All" & svi_bin3 == "All" & svi_bin4 == "All" & rural_urban_class == "All" & Education == 666 & method == "di_gee" & scenario == "real" & measure2 == "age-adjusted rate per 100,000" & Region == "United States" & min_age == 25 & measure3 == "proportion of disparity to Black or African American attributable" & Ethnicity %in% c("Hispanic or Latino White", "Asian or Pacific Islander", "American Indian or Alaska Native")) %>%
  group_by(Ethnicity)
```

In the year 2016, those with a high school diploma or lower experienced a 16.9 (95% CI, 16.4 to 17.4) PM2.5-attributable age-adjusted deaths per 100,000 (Fig. 1). This rate is nearly double compared to those with some college education but no 4-year degree, who had a rate of 8.8 (95% CI, 8.5 to 9.0), and those with a 4-year college degree or higher, who had a rate of 7.7 (95% CI, 7.5 to 7.9) (Fig. 1). 
```{r}
attr_burden %>%
  filter(Year %in% 2016 & svi_bin == "All" & svi_bin1 == "All" & svi_bin2 == "All" & svi_bin3 == "All" & svi_bin4 == "All" & rural_urban_class == "All" & Education != "666" & method == "di_gee" & scenario == "real" & measure2 == "age-adjusted rate per 100,000" & Region == "United States" & min_age == 25 & measure3 == "value" & Ethnicity == "All, All Origins") %>%
  select( mean, lower, upper, Education)
```

